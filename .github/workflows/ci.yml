name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ['3.9', '3.10', '3.11']
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}
    
    - name: Cache pip packages
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip setuptools wheel
        pip install -r requirements.txt
    
    - name: Lint with flake8
      run: |
        # Stop the build if there are Python syntax errors or undefined names
        flake8 src tests --count --select=E9,F63,F7,F82 --show-source --statistics
        # Exit-zero treats all errors as warnings
        flake8 src tests --count --exit-zero --max-complexity=10 --max-line-length=100 --statistics
      continue-on-error: true
    
    - name: Format check with black
      run: |
        black --check src tests || true
      continue-on-error: true
    
    - name: Run tests with pytest
      run: |
        if [ -f pytest.ini ] || [ -d tests ]; then
          pytest tests/ -v --tb=short --cov=src --cov-report=term-missing
        else
          echo "No tests found in tests/ directory"
        fi
      continue-on-error: true
    
    - name: Check notebook outputs are stripped
      run: |
        find . -name "*.ipynb" -type f | while read notebook; do
          if grep -q "\"outputs\":" "$notebook" 2>/dev/null; then
            if grep -q "\"output_type\":" "$notebook" 2>/dev/null; then
              echo "⚠️  Warning: $notebook contains output cells (consider running nbstripout)"
            fi
          fi
        done
      continue-on-error: true

  build:
    runs-on: ubuntu-latest
    needs: test
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Verify imports
      run: |
        python -c "import numpy; print(f'✅ NumPy {numpy.__version__}')"
        python -c "import pandas; print(f'✅ Pandas {pandas.__version__}')"
        python -c "import sklearn; print(f'✅ Scikit-learn {sklearn.__version__}')"
        python -c "import torch; print(f'✅ PyTorch {torch.__version__}')" || echo "ℹ️  PyTorch not available (optional)"
    
    - name: Test data loading
      run: |
        python -c "
import numpy as np
import os
if os.path.exists('X_train_scaled.npy'):
    X = np.load('X_train_scaled.npy')
    print(f'✅ Data files loading successfully: {X.shape}')
else:
    print('ℹ️  Data files not found (expected in local environment)')
        "

  docs:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Verify README exists
      run: |
        if [ -f README.md ]; then
          echo "✅ README.md exists"
          wc -l README.md
        else
          echo "❌ README.md not found"
          exit 1
        fi
    
    - name: Verify required documentation files
      run: |
        files=("LICENSE" "CONTRIBUTING.md" "data/README.md")
        for file in "${files[@]}"; do
          if [ -f "$file" ]; then
            echo "✅ $file exists"
          else
            echo "⚠️  $file not found"
          fi
        done
